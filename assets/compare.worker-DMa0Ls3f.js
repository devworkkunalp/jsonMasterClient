(function(){"use strict";self.onmessage=async o=>{const{file1:a,file2:r,keyField:d,ignoredFields:t}=o.data;try{const l=new Set(t?t.split(",").map(c=>c.trim().toLowerCase()).filter(c=>c):[]);self.postMessage({type:"PROGRESS",message:"Reading and parsing files..."});const i=await a.text(),u=await r.text(),s=JSON.parse(i),n=JSON.parse(u),e={modified:[],added:[],removed:[],unchanged:[],summary:{totalRecords:0,modifiedCount:0,addedCount:0,removedCount:0,unchangedCount:0}};self.postMessage({type:"PROGRESS",message:"Comparing records..."});const O=y(s,d),C=y(n,d),S=new Set([...Object.keys(O),...Object.keys(C)]);e.summary.totalRecords=S.size;for(const c of S){const R=O[c]||[],k=C[c]||[],w=Math.max(R.length,k.length);for(let m=0;m<w;m++){const f=R[m],g=k[m];if(f&&g){const A=h(f,g,"",l);A.length>0?e.modified.push({keyValue:c,source:f,target:g,differences:A}):e.unchanged.push(f)}else f?e.removed.push(f):g&&e.added.push(g)}}e.summary.modifiedCount=e.modified.length,e.summary.addedCount=e.added.length,e.summary.removedCount=e.removed.length,e.summary.unchangedCount=e.unchanged.length,e.summary.totalRecords=e.modified.length+e.added.length+e.removed.length+e.unchanged.length,self.postMessage({type:"COMPLETE",result:e})}catch(l){self.postMessage({type:"ERROR",error:l.message})}};function y(o,a){return Array.isArray(o)?o.reduce((r,d)=>{const t=d[a]!==void 0?String(d[a]):"no-key";return r[t]||(r[t]=[]),r[t].push(d),r},{}):{}}function h(o,a,r,d){const t=[],l=new Set([...Object.keys(o),...Object.keys(a)]);for(const i of l){if(d.has(i.toLowerCase()))continue;const u=r?`${r}.${i}`:i,s=o[i],n=a[i];s!==void 0&&n===void 0?t.push({path:u,sourceValue:s,targetValue:null,changeType:"removed"}):s===void 0&&n!==void 0?t.push({path:u,sourceValue:null,targetValue:n,changeType:"added"}):s!==n&&(p(s)&&p(n)?t.push(...h(s,n,u,d)):Array.isArray(s)&&Array.isArray(n)?JSON.stringify(s)!==JSON.stringify(n)&&t.push({path:u,sourceValue:s,targetValue:n,changeType:"modified"}):s!==n&&t.push({path:u,sourceValue:s,targetValue:n,changeType:"modified"}))}return t}function p(o){return o&&typeof o=="object"&&!Array.isArray(o)}})();
