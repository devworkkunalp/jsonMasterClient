(function(){"use strict";self.onmessage=async o=>{const{file1:d,file2:a,keyField:i,ignoredFields:s}=o.data;try{const y=new Set(s?s.split(",").map(t=>t.trim().toLowerCase()).filter(t=>t):[]);self.postMessage({type:"PROGRESS",message:"Reading and parsing files..."});const u=await d.text(),c=await a.text();let n=JSON.parse(u),r=JSON.parse(c);const R=t=>{if(Array.isArray(t))return t;if(t&&typeof t=="object"){let f=null;for(const l in t)Array.isArray(t[l])&&(!f||t[l].length>f.length)&&(f=t[l]);return f}return null},p=R(n),O=R(r);if(!p||!O)throw new Error("Could not find an array of items to compare. Ensure your JSON contains a list of objects.");self.postMessage({type:"PROGRESS",message:`Found ${p.length} items in source and ${O.length} in target. Starting comparison...`});const e={modified:[],added:[],removed:[],unchanged:[],summary:{totalRecords:0,modifiedCount:0,addedCount:0,removedCount:0,unchangedCount:0}};self.postMessage({type:"PROGRESS",message:"Comparing records..."});const k=S(p,i),w=S(O,i),E=new Set([...Object.keys(k),...Object.keys(w)]);e.summary.totalRecords=E.size;for(const t of E){const f=k[t]||[],l=w[t]||[],T=Math.max(f.length,l.length);for(let h=0;h<T;h++){const g=f[h],m=l[h];if(g&&m){const M=A(g,m,"",y);M.length>0?e.modified.push({keyValue:t,source:g,target:m,differences:M}):e.unchanged.push(g)}else g?e.removed.push(g):m&&e.added.push(m)}}e.summary.modifiedCount=e.modified.length,e.summary.addedCount=e.added.length,e.summary.removedCount=e.removed.length,e.summary.unchangedCount=e.unchanged.length,e.summary.totalRecords=e.modified.length+e.added.length+e.removed.length+e.unchanged.length,self.postMessage({type:"COMPLETE",result:e})}catch(y){self.postMessage({type:"ERROR",error:y.message})}};function S(o,d){return Array.isArray(o)?o.reduce((a,i)=>{const s=i[d]!==void 0?String(i[d]):"no-key";return a[s]||(a[s]=[]),a[s].push(i),a},{}):{}}function A(o,d,a,i){const s=[],y=new Set([...Object.keys(o),...Object.keys(d)]);for(const u of y){if(i.has(u.toLowerCase()))continue;const c=a?`${a}.${u}`:u,n=o[u],r=d[u];n!==void 0&&r===void 0?s.push({path:c,sourceValue:n,targetValue:null,changeType:"removed"}):n===void 0&&r!==void 0?s.push({path:c,sourceValue:null,targetValue:r,changeType:"added"}):n!==r&&(C(n)&&C(r)?s.push(...A(n,r,c,i)):Array.isArray(n)&&Array.isArray(r)?JSON.stringify(n)!==JSON.stringify(r)&&s.push({path:c,sourceValue:n,targetValue:r,changeType:"modified"}):n!==r&&s.push({path:c,sourceValue:n,targetValue:r,changeType:"modified"}))}return s}function C(o){return o&&typeof o=="object"&&!Array.isArray(o)}})();
