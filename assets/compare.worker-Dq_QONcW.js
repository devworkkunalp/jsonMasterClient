(function(){"use strict";self.onmessage=async o=>{const{file1:d,file2:a,keyField:i,ignoredFields:s}=o.data;try{const l=new Set(s?s.split(",").map(t=>t.trim().toLowerCase()).filter(t=>t):[]);self.postMessage({type:"PROGRESS",message:"Reading and parsing files..."});const u=await d.text(),c=await a.text();let r=JSON.parse(u),n=JSON.parse(c);const C=t=>{if(Array.isArray(t))return t;if(t&&typeof t=="object"){for(const y in t)if(Array.isArray(t[y]))return t[y]}return null},O=C(r),S=C(n);if(!O||!S)throw new Error("Could not find an array of items to compare in one or both files.");const e={modified:[],added:[],removed:[],unchanged:[],summary:{totalRecords:0,modifiedCount:0,addedCount:0,removedCount:0,unchangedCount:0}};self.postMessage({type:"PROGRESS",message:"Comparing records..."});const R=h(O,i),k=h(S,i),w=new Set([...Object.keys(R),...Object.keys(k)]);e.summary.totalRecords=w.size;for(const t of w){const y=R[t]||[],T=k[t]||[],x=Math.max(y.length,T.length);for(let m=0;m<x;m++){const f=y[m],g=T[m];if(f&&g){const v=p(f,g,"",l);v.length>0?e.modified.push({keyValue:t,source:f,target:g,differences:v}):e.unchanged.push(f)}else f?e.removed.push(f):g&&e.added.push(g)}}e.summary.modifiedCount=e.modified.length,e.summary.addedCount=e.added.length,e.summary.removedCount=e.removed.length,e.summary.unchangedCount=e.unchanged.length,e.summary.totalRecords=e.modified.length+e.added.length+e.removed.length+e.unchanged.length,self.postMessage({type:"COMPLETE",result:e})}catch(l){self.postMessage({type:"ERROR",error:l.message})}};function h(o,d){return Array.isArray(o)?o.reduce((a,i)=>{const s=i[d]!==void 0?String(i[d]):"no-key";return a[s]||(a[s]=[]),a[s].push(i),a},{}):{}}function p(o,d,a,i){const s=[],l=new Set([...Object.keys(o),...Object.keys(d)]);for(const u of l){if(i.has(u.toLowerCase()))continue;const c=a?`${a}.${u}`:u,r=o[u],n=d[u];r!==void 0&&n===void 0?s.push({path:c,sourceValue:r,targetValue:null,changeType:"removed"}):r===void 0&&n!==void 0?s.push({path:c,sourceValue:null,targetValue:n,changeType:"added"}):r!==n&&(A(r)&&A(n)?s.push(...p(r,n,c,i)):Array.isArray(r)&&Array.isArray(n)?JSON.stringify(r)!==JSON.stringify(n)&&s.push({path:c,sourceValue:r,targetValue:n,changeType:"modified"}):r!==n&&s.push({path:c,sourceValue:r,targetValue:n,changeType:"modified"}))}return s}function A(o){return o&&typeof o=="object"&&!Array.isArray(o)}})();
